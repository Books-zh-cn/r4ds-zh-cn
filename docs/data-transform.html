<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hadley Wickham, Mine Çetinkaya-Rundel, and Garrett Grolemund">
<title>R for Data Science (2e) - 4&nbsp; Data transformation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./workflow-style.html" rel="next">
<link href="./workflow-basics.html" rel="prev">
<link href="./cover.jpg" rel="icon" type="image/jpeg">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script defer="" data-domain="r4ds.hadley.nz" src="https://plausible.io/js/plausible.js"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data transformation</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R for Data Science (2e)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/zhenghu159/r4ds-zh-cn" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle sidebar-tool" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface-2e.html" class="sidebar-item-text sidebar-link">Preface to the second edition</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./whole-game.html" class="sidebar-item-text sidebar-link">Whole game</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-visualize.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-basics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Workflow: basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-transform.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data transformation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-style.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Workflow: code style</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-tidy.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data tidying</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-scripts.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Workflow: scripts and projects</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-import.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Data import</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-help.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Workflow: getting help</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./visualize.html" class="sidebar-item-text sidebar-link">Visualize</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./layers.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Layers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./EDA.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Exploratory data analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./communication.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Communication</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./transform.html" class="sidebar-item-text sidebar-link">Transform</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./logicals.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Logical vectors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./numbers.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Numbers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./strings.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Strings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regexps.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Regular expressions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./factors.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Factors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datetimes.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Dates and times</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missing-values.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Missing values</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./joins.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Joins</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./import.html" class="sidebar-item-text sidebar-link">Import</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spreadsheets.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Spreadsheets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./databases.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Databases</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./arrow.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Arrow</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rectangling.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Hierarchical data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./webscraping.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Web scraping</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./program.html" class="sidebar-item-text sidebar-link">Program</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./iteration.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Iteration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./base-R.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">A field guide to base R</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./communicate.html" class="sidebar-item-text sidebar-link">Communicate</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Quarto</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto-formats.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Quarto formats</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="toc-section-number">4.1</span>  Introduction</a>
  <ul class="collapse">
<li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites"><span class="toc-section-number">4.1.1</span>  Prerequisites</a></li>
  <li><a href="#nycflights13" id="toc-nycflights13" class="nav-link" data-scroll-target="#nycflights13"><span class="toc-section-number">4.1.2</span>  nycflights13</a></li>
  <li><a href="#dplyr-basics" id="toc-dplyr-basics" class="nav-link" data-scroll-target="#dplyr-basics"><span class="toc-section-number">4.1.3</span>  dplyr basics</a></li>
  </ul>
</li>
  <li>
<a href="#rows" id="toc-rows" class="nav-link" data-scroll-target="#rows"><span class="toc-section-number">4.2</span>  Rows</a>
  <ul class="collapse">
<li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter"><span class="toc-section-number">4.2.1</span>  <code>filter()</code></a></li>
  <li><a href="#common-mistakes" id="toc-common-mistakes" class="nav-link" data-scroll-target="#common-mistakes"><span class="toc-section-number">4.2.2</span>  Common mistakes</a></li>
  <li><a href="#arrange" id="toc-arrange" class="nav-link" data-scroll-target="#arrange"><span class="toc-section-number">4.2.3</span>  <code>arrange()</code></a></li>
  <li><a href="#distinct" id="toc-distinct" class="nav-link" data-scroll-target="#distinct"><span class="toc-section-number">4.2.4</span>  <code>distinct()</code></a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="toc-section-number">4.2.5</span>  Exercises</a></li>
  </ul>
</li>
  <li>
<a href="#columns" id="toc-columns" class="nav-link" data-scroll-target="#columns"><span class="toc-section-number">4.3</span>  Columns</a>
  <ul class="collapse">
<li><a href="#sec-mutate" id="toc-sec-mutate" class="nav-link" data-scroll-target="#sec-mutate"><span class="toc-section-number">4.3.1</span>  <code>mutate()</code></a></li>
  <li><a href="#sec-select" id="toc-sec-select" class="nav-link" data-scroll-target="#sec-select"><span class="toc-section-number">4.3.2</span>  <code>select()</code></a></li>
  <li><a href="#rename" id="toc-rename" class="nav-link" data-scroll-target="#rename"><span class="toc-section-number">4.3.3</span>  <code>rename()</code></a></li>
  <li><a href="#relocate" id="toc-relocate" class="nav-link" data-scroll-target="#relocate"><span class="toc-section-number">4.3.4</span>  <code>relocate()</code></a></li>
  <li><a href="#exercises-1" id="toc-exercises-1" class="nav-link" data-scroll-target="#exercises-1"><span class="toc-section-number">4.3.5</span>  Exercises</a></li>
  </ul>
</li>
  <li><a href="#sec-the-pipe" id="toc-sec-the-pipe" class="nav-link" data-scroll-target="#sec-the-pipe"><span class="toc-section-number">4.4</span>  The pipe</a></li>
  <li>
<a href="#groups" id="toc-groups" class="nav-link" data-scroll-target="#groups"><span class="toc-section-number">4.5</span>  Groups</a>
  <ul class="collapse">
<li><a href="#group_by" id="toc-group_by" class="nav-link" data-scroll-target="#group_by"><span class="toc-section-number">4.5.1</span>  <code>group_by()</code></a></li>
  <li><a href="#sec-summarize" id="toc-sec-summarize" class="nav-link" data-scroll-target="#sec-summarize"><span class="toc-section-number">4.5.2</span>  <code>summarize()</code></a></li>
  <li><a href="#the-slice_-functions" id="toc-the-slice_-functions" class="nav-link" data-scroll-target="#the-slice_-functions"><span class="toc-section-number">4.5.3</span>  The <code>slice_</code> functions</a></li>
  <li><a href="#grouping-by-multiple-variables" id="toc-grouping-by-multiple-variables" class="nav-link" data-scroll-target="#grouping-by-multiple-variables"><span class="toc-section-number">4.5.4</span>  Grouping by multiple variables</a></li>
  <li><a href="#ungrouping" id="toc-ungrouping" class="nav-link" data-scroll-target="#ungrouping"><span class="toc-section-number">4.5.5</span>  Ungrouping</a></li>
  <li><a href="#by" id="toc-by" class="nav-link" data-scroll-target="#by"><span class="toc-section-number">4.5.6</span>  <code>.by</code></a></li>
  <li><a href="#exercises-2" id="toc-exercises-2" class="nav-link" data-scroll-target="#exercises-2"><span class="toc-section-number">4.5.7</span>  Exercises</a></li>
  </ul>
</li>
  <li><a href="#sec-sample-size" id="toc-sec-sample-size" class="nav-link" data-scroll-target="#sec-sample-size"><span class="toc-section-number">4.6</span>  Case study: aggregates and sample size</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="toc-section-number">4.7</span>  Summary</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/zhenghu159/r4ds-zh-cn/edit/main/data-transform.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/zhenghu159/r4ds-zh-cn/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-data-transform" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data transformation</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><div class="status">
<div class="callout-note callout callout-style-simple">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>You are reading the work-in-progress second edition of R for Data Science. This chapter is largely complete and just needs final proof reading. You can find the complete first edition at <a href="https://r4ds.had.co.nz" class="uri">https://r4ds.had.co.nz</a>.</p>
</div>
</div>
</div>
</div>
<section id="introduction" class="level2" data-number="4.1"><h2 data-number="4.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">4.1</span> Introduction</h2>
<p>可视化是生成洞察力的重要工具，但很少有数据以完全符合你所需的形式提供，以制作你想要的图形。 通常情况下，你需要创建一些新的变量或摘要统计信息来回答你的问题，或者你可能只是想重命名变量或重新排序观测结果，以便更轻松地处理数据。 在本章中，你将学习如何使用 <strong>dplyr</strong> 包进行数据转换（data transformation），并使用关于 2013 年从纽约市出发的航班的新数据集来介绍这些内容，并且你还将学习更多相关的知识！</p>
<p>本章的目标是为你提供转换数据框的所有关键工具的概述。 我们将从对数据框的行和列进行操作的函数开始，然后再回到管道操作符的讨论，这是一个重要的工具，用于组合操作。 然后，我们将介绍如何使用分组进行操作。 最后，我们将通过一个案例研究展示这些函数的实际应用，并在后续章节中更详细地讨论这些函数，以便深入研究特定类型的数据 (e.g., numbers, strings, dates)。</p>
<section id="prerequisites" class="level3" data-number="4.1.1"><h3 data-number="4.1.1" class="anchored" data-anchor-id="prerequisites">
<span class="header-section-number">4.1.1</span> Prerequisites</h3>
<p>在本章中，我们将关注 dplyr 包，它是 tidyverse 的另一个核心成员。 我们将使用 nycflights13 包中的数据说明关键思想，并使用 ggplot2 帮助我们理解数据。</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/nycflights13">nycflights13</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'nycflights13' was built under R version 4.2.3</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'tidyverse' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'ggplot2' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'tibble' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'tidyr' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'readr' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'purrr' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'dplyr' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'stringr' was built under R version 4.2.2</span></span>
<span><span class="co">#&gt; Warning: package 'forcats' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'lubridate' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; ── Attaching core tidyverse packages ───────────────────── tidyverse 2.0.0 ──</span></span>
<span><span class="co">#&gt; ✔ dplyr     1.1.2     ✔ readr     2.1.4</span></span>
<span><span class="co">#&gt; ✔ forcats   1.0.0     ✔ stringr   1.5.0</span></span>
<span><span class="co">#&gt; ✔ ggplot2   3.4.2     ✔ tibble    3.2.1</span></span>
<span><span class="co">#&gt; ✔ lubridate 1.9.2     ✔ tidyr     1.3.0</span></span>
<span><span class="co">#&gt; ✔ purrr     1.0.1     </span></span>
<span><span class="co">#&gt; ── Conflicts ─────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">#&gt; ✖ dplyr::filter() masks stats::filter()</span></span>
<span><span class="co">#&gt; ✖ dplyr::lag()    masks stats::lag()</span></span>
<span><span class="co">#&gt; ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>请仔细注意加载 tidyverse 时打印的冲突消息（conflicts message）。 它告诉你 dplyr 覆盖了 base R 中的一些函数。 如果你想在加载 dplyr 后使用这些函数的 base 版本，你需要使用它们的全名：<code><a href="https://rdrr.io/r/stats/filter.html">stats::filter()</a></code> 和 <code><a href="https://rdrr.io/r/stats/lag.html">stats::lag()</a></code>。 到目前为止，我们大多忽略了一个函数来自哪个包，因为大多数时候它并不重要。 但是，了解包可以帮助您找到帮助并找到相关函数，因此当我们需要准确了解某个函数来自哪个包时，我们将使用与 R 相同的语法：<code>packagename::functionname()</code>。</p>
</section><section id="nycflights13" class="level3" data-number="4.1.2"><h3 data-number="4.1.2" class="anchored" data-anchor-id="nycflights13">
<span class="header-section-number">4.1.2</span> nycflights13</h3>
<p>为了探索基本的 dplyr verbs，我们将使用 <code><a href="https://rdrr.io/pkg/nycflights13/man/flights.html">nycflights13::flights</a></code>。 该数据集包含 2013 年从纽约市起飞的所有 336,776 航班。 数据来自美国 <a href="http://www.transtats.bts.gov/DatabaseInfo.asp?DB_ID=120&amp;Link=0">Bureau of Transportation Statistics</a>，记录在 <code><a href="https://rdrr.io/pkg/nycflights13/man/flights.html">?flights</a></code> 中。</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>flights</code> 是一个 tibble，一种特殊类型的 data frame，tidyverse 使用它来避免一些常见的问题。 tibbles 和 data frame 之间最重要的区别是 tibbles 的打印方式； 它们是为大型数据集设计的，因此它们只显示前几行，并且只显示适合一个屏幕的列。 有几个选项可以查看所有内容。 如果您使用的是 RStudio，最方便的可能是 <code>View(flights)</code>，它将打开一个交互式的可滚动和可过滤的视图。 另外，您可以使用 <code>print(flights, width = Inf)</code> 来显示所有列，或使用 <code><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse()</a></code>：</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 336,776</span></span>
<span><span class="co">#&gt; Columns: 19</span></span>
<span><span class="co">#&gt; $ year           &lt;int&gt; 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013…</span></span>
<span><span class="co">#&gt; $ month          &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…</span></span>
<span><span class="co">#&gt; $ day            &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…</span></span>
<span><span class="co">#&gt; $ dep_time       &lt;int&gt; 517, 533, 542, 544, 554, 554, 555, 557, 557, 558, 55…</span></span>
<span><span class="co">#&gt; $ sched_dep_time &lt;int&gt; 515, 529, 540, 545, 600, 558, 600, 600, 600, 600, 60…</span></span>
<span><span class="co">#&gt; $ dep_delay      &lt;dbl&gt; 2, 4, 2, -1, -6, -4, -5, -3, -3, -2, -2, -2, -2, -2,…</span></span>
<span><span class="co">#&gt; $ arr_time       &lt;int&gt; 830, 850, 923, 1004, 812, 740, 913, 709, 838, 753, 8…</span></span>
<span><span class="co">#&gt; $ sched_arr_time &lt;int&gt; 819, 830, 850, 1022, 837, 728, 854, 723, 846, 745, 8…</span></span>
<span><span class="co">#&gt; $ arr_delay      &lt;dbl&gt; 11, 20, 33, -18, -25, 12, 19, -14, -8, 8, -2, -3, 7,…</span></span>
<span><span class="co">#&gt; $ carrier        &lt;chr&gt; "UA", "UA", "AA", "B6", "DL", "UA", "B6", "EV", "B6"…</span></span>
<span><span class="co">#&gt; $ flight         &lt;int&gt; 1545, 1714, 1141, 725, 461, 1696, 507, 5708, 79, 301…</span></span>
<span><span class="co">#&gt; $ tailnum        &lt;chr&gt; "N14228", "N24211", "N619AA", "N804JB", "N668DN", "N…</span></span>
<span><span class="co">#&gt; $ origin         &lt;chr&gt; "EWR", "LGA", "JFK", "JFK", "LGA", "EWR", "EWR", "LG…</span></span>
<span><span class="co">#&gt; $ dest           &lt;chr&gt; "IAH", "IAH", "MIA", "BQN", "ATL", "ORD", "FLL", "IA…</span></span>
<span><span class="co">#&gt; $ air_time       &lt;dbl&gt; 227, 227, 160, 183, 116, 150, 158, 53, 140, 138, 149…</span></span>
<span><span class="co">#&gt; $ distance       &lt;dbl&gt; 1400, 1416, 1089, 1576, 762, 719, 1065, 229, 944, 73…</span></span>
<span><span class="co">#&gt; $ hour           &lt;dbl&gt; 5, 5, 5, 5, 6, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 6…</span></span>
<span><span class="co">#&gt; $ minute         &lt;dbl&gt; 15, 29, 40, 45, 0, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59…</span></span>
<span><span class="co">#&gt; $ time_hour      &lt;dttm&gt; 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2013-01-0…</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在这两个视图中，变量名称后跟缩写，告诉您每个变量的类型：<code>&lt;int&gt;</code> 是整数（integer）的缩写，<code>&lt;dbl&gt;</code> 是双精度（double）（又名实数）的缩写，<code>&lt;chr&gt;</code> 用于字符（character）（也称为字符串），<code>&lt;dttm&gt;</code> 用于日期时间（date-time）。 这些很重要，因为您可以对列执行的操作在很大程度上取决于其”类型”。</p>
</section><section id="dplyr-basics" class="level3" data-number="4.1.3"><h3 data-number="4.1.3" class="anchored" data-anchor-id="dplyr-basics">
<span class="header-section-number">4.1.3</span> dplyr basics</h3>
<p>您将学习主要的 dplyr verbs（functions），这将使您能够解决绝大多数数据操作挑战。 但在我们讨论它们的个体差异之前，有必要先说明一下它们的共同点：</p>
<ol type="1">
<li><p>第一个参数始终是一个 data frame。</p></li>
<li><p>随后的参数通常使用变量名称（不带引号）描述要对哪些列进行操作。</p></li>
<li><p>输出总是一个新的 data frame。</p></li>
</ol>
<p>因为每个 verb 都擅长做一件事，解决复杂问题通常需要组合多个 verbs，我们将使用竖线 <code>|&gt;</code> 来实现。 我们将在 <a href="#sec-the-pipe"><span>Section&nbsp;4.4</span></a> 中更多地讨论管道，但简而言之，管道将其左侧的东西传递给右侧的函数，因此 <code>x |&gt; f(y)</code> 等价于 <code>f(x, y)</code>，而 <code>x |&gt; f(y) |&gt; g(z)</code> 等价于 <code>g(f(x, y), z)</code>。 管道的最简单发音是 “then”。 即使您尚未了解详细信息，也可以了解以下代码：</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="st">"IAH"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    arr_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">arr_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>dplyr 的 verbs 根据操作对象分为四组：<strong>rows</strong>, <strong>columns</strong>, <strong>groups</strong>, or <strong>tables</strong>。 在接下来的部分中，您将学习 rows、columns 和 groups 最重要的 verbs，然后我们将回到 <a href="joins.html"><span>Chapter&nbsp;20</span></a> 中用于 tables 的连接动词。 让我们开始吧！</p>
</section></section><section id="rows" class="level2" data-number="4.2"><h2 data-number="4.2" class="anchored" data-anchor-id="rows">
<span class="header-section-number">4.2</span> Rows</h2>
<p>对数据集的行进行操作的最重要的 verbs 是 <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>，它改变了哪些行存在而不改变它们的顺序，以及 <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>，它改变了行的顺序而不改变存在的行。 这两个函数只影响行，列保持不变。 我们还将讨论 <code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code>，它可以找到具有唯一值的行，但与 <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> 不同的是，它还可以选择性地修改列。</p>
<section id="filter" class="level3" data-number="4.2.1"><h3 data-number="4.2.1" class="anchored" data-anchor-id="filter">
<span class="header-section-number">4.2.1</span> <code>filter()</code>
</h3>
<p><code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> 允许您根据列的值保留行<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。 第一个参数是 data frame。 第二个和后续参数是必须为真才能保留该行的条件。 例如，我们可以找到所有晚点超过 120 分钟（两小时）的航班：</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dep_delay</span> <span class="op">&gt;</span> <span class="fl">120</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 9,723 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      848           1835       853     1001           1950</span></span>
<span><span class="co">#&gt; 2  2013     1     1      957            733       144     1056            853</span></span>
<span><span class="co">#&gt; 3  2013     1     1     1114            900       134     1447           1222</span></span>
<span><span class="co">#&gt; 4  2013     1     1     1540           1338       122     2020           1825</span></span>
<span><span class="co">#&gt; 5  2013     1     1     1815           1325       290     2120           1542</span></span>
<span><span class="co">#&gt; 6  2013     1     1     1842           1422       260     1958           1535</span></span>
<span><span class="co">#&gt; # ℹ 9,717 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>除了 <code>&gt;</code>（大于），您还可以使用 <code>&gt;=</code>（大于或等于）、<code>&lt;</code>（小于）、<code>&lt;=</code>（小于或等于）、<code>==</code> （等于）和 <code>!=</code>（不等于）。 您还可以将条件与 <code>&amp;</code> 或 <code>,</code> 结合起来以指示 “and”（检查两个条件）或与 <code>|</code> 结合以指示 “or”（检查任一条件）：</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Flights that departed on January 1</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 842 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 836 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span>
<span></span>
<span><span class="co"># Flights that departed in January or February</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">month</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 51,955 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 51,949 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>组合 <code>|</code> 和 <code>==</code> 时有一个有用的快捷方式：<code>%in%</code>。 它保留变量等于右侧值之一的行：</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># A shorter way to select flights that departed in January or February</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 51,955 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 51,949 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>我们将在 <a href="logicals.html"><span>Chapter&nbsp;13</span></a> 中更详细地回到这些比较和逻辑运算符。</p>
<p>当你运行 <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> 时，dplyr 执行过滤操作，创建一个新的数据框，然后打印它。 它不会修改现有的 <code>flights</code> 数据集，因为 dplyr 函数从不修改其输入。 要保存结果，您需要使用赋值运算符，<code>&lt;-</code>：</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">jan1</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="common-mistakes" class="level3" data-number="4.2.2"><h3 data-number="4.2.2" class="anchored" data-anchor-id="common-mistakes">
<span class="header-section-number">4.2.2</span> Common mistakes</h3>
<p>当您开始使用 R 时，最容易犯的错误是在测试相等性时使用 <code>=</code> 而不是 <code>==</code>。 <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> 会在发生这种情况时通知您：</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in `filter()`:</span></span>
<span><span class="co">#&gt; ! We detected a named input.</span></span>
<span><span class="co">#&gt; ℹ This usually means that you've used `=` instead of `==`.</span></span>
<span><span class="co">#&gt; ℹ Did you mean `month == 1`?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>另一个错误是你像用英语那样写 “or” 语句：</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>这个能够工作，因为它不会抛出错误，但它不会得到你想要的结果，因为 <code>|</code> 首先检查条件 <code>month == 1</code> 然后检查条件 <code>2</code>，这不是一个明智的检查条件。 我们将在 <a href="regexps.html#sec-boolean-operations"><span>Section&nbsp;16.6.2</span></a> 中详细了解这里发生的事情以及原因。</p>
</section><section id="arrange" class="level3" data-number="4.2.3"><h3 data-number="4.2.3" class="anchored" data-anchor-id="arrange">
<span class="header-section-number">4.2.3</span> <code>arrange()</code>
</h3>
<p><code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> 根据列（columns）的值更改行（rows）的顺序。 它接受一个 data frame 和一组要按顺序排列的列名（column names）（或更复杂的表达式）。 如果提供多个列名（column names），每个额外的列将用于解决前面列的值相等的情况。 例如，下面的代码按照出发时间排序，该时间跨越了四列。 我们首先获取最早的年份（years），然后在一年内获取最早的月份（months），以此类推。</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span>, <span class="va">dep_time</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在 <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> 内部，您可以对列使用 <code><a href="https://dplyr.tidyverse.org/reference/desc.html">desc()</a></code> 函数，以便按降序（从大到小）重新排序数据框。 例如，以下代码按延误时间从最长到最短的顺序排序航班：</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">dep_delay</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     9      641            900      1301     1242           1530</span></span>
<span><span class="co">#&gt; 2  2013     6    15     1432           1935      1137     1607           2120</span></span>
<span><span class="co">#&gt; 3  2013     1    10     1121           1635      1126     1239           1810</span></span>
<span><span class="co">#&gt; 4  2013     9    20     1139           1845      1014     1457           2210</span></span>
<span><span class="co">#&gt; 5  2013     7    22      845           1600      1005     1044           1815</span></span>
<span><span class="co">#&gt; 6  2013     4    10     1100           1900       960     1342           2211</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>请注意，行的数量没有改变 – 我们只是重新排列了数据，而没有对其进行筛选。</p>
</section><section id="distinct" class="level3" data-number="4.2.4"><h3 data-number="4.2.4" class="anchored" data-anchor-id="distinct">
<span class="header-section-number">4.2.4</span> <code>distinct()</code>
</h3>
<p><code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code> 函数用于在数据集中查找所有唯一的行，因此从技术上讲，它主要操作行。 然而，大多数情况下，您希望获取某些变量的唯一组合，因此您也可以选择性地提供列名：</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Remove duplicate rows, if any</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span>
<span></span>
<span><span class="co"># Find all unique origin and destination pairs</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">dest</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 224 × 2</span></span>
<span><span class="co">#&gt;   origin dest </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 EWR    IAH  </span></span>
<span><span class="co">#&gt; 2 LGA    IAH  </span></span>
<span><span class="co">#&gt; 3 JFK    MIA  </span></span>
<span><span class="co">#&gt; 4 JFK    BQN  </span></span>
<span><span class="co">#&gt; 5 LGA    ATL  </span></span>
<span><span class="co">#&gt; 6 EWR    ORD  </span></span>
<span><span class="co">#&gt; # ℹ 218 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>另外，如果您在筛选唯一行时想要保留其他列，可以使用 <code>.keep_all = TRUE</code> 选项。</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">dest</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 224 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 218 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>并非巧合，所有这些唯一的航班都是在 1 月 1 日：<code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code> 函数将找到数据集中唯一行的第一个出现，并丢弃其余的重复行。</p>
<p>如果您想找到每个唯一行的出现次数，最好将 <code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code> 替换为 <code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code> 函数，并使用 <code>sort = TRUE</code> 参数按出现次数的降序排列它们。 您可以在 <a href="numbers.html#sec-counts"><span>Section&nbsp;14.3</span></a> 中了解更多关于 <code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code> 函数的内容。</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">dest</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 224 × 3</span></span>
<span><span class="co">#&gt;   origin dest      n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;chr&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 JFK    LAX   11262</span></span>
<span><span class="co">#&gt; 2 LGA    ATL   10263</span></span>
<span><span class="co">#&gt; 3 LGA    ORD    8857</span></span>
<span><span class="co">#&gt; 4 JFK    SFO    8204</span></span>
<span><span class="co">#&gt; 5 LGA    CLT    6168</span></span>
<span><span class="co">#&gt; 6 EWR    ORD    6100</span></span>
<span><span class="co">#&gt; # ℹ 218 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="exercises" class="level3" data-number="4.2.5"><h3 data-number="4.2.5" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">4.2.5</span> Exercises</h3>
<ol type="1">
<li>
<p>在每个条件的单个管道中，找到满足条件的所有航班（flights）：</p>
<ul>
<li>Had an arrival delay of two or more hours</li>
<li>Flew to Houston (<code>IAH</code> or <code>HOU</code>)</li>
<li>Were operated by United, American, or Delta</li>
<li>Departed in summer (July, August, and September)</li>
<li>Arrived more than two hours late, but didn’t leave late</li>
<li>Were delayed by at least an hour, but made up over 30 minutes in flight</li>
</ul>
</li>
<li><p>对 <code>flights</code> 进行排序以查找起飞延误（departure delays）时间最长的航班。 查找早上最早起飞的航班。</p></li>
<li><p>对 <code>flights</code> 进行排序以找到最快的航班。 （提示：尝试在你的函数中包含一个数学计算。）</p></li>
<li><p>2013 年每天都有航班吗？</p></li>
<li><p>哪些航班飞行距离最远？ 哪个航班飞行距离最短？</p></li>
<li><p>如果同时使用 <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>，那么使用它们的顺序有什么关系吗？ 为什么/为什么不？ 考虑结果以及功能必须完成的工作量。</p></li>
</ol></section></section><section id="columns" class="level2" data-number="4.3"><h2 data-number="4.3" class="anchored" data-anchor-id="columns">
<span class="header-section-number">4.3</span> Columns</h2>
<p>有四个重要的 verbs 可以在不更改行的情况下影响列：<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> 创建从现有列派生的新列，<code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> 更改存在的列，<code><a href="https://dplyr.tidyverse.org/reference/rename.html">rename()</a></code> 更改列的名称， <code><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate()</a></code> 更改列的位置。</p>
<section id="sec-mutate" class="level3" data-number="4.3.1"><h3 data-number="4.3.1" class="anchored" data-anchor-id="sec-mutate">
<span class="header-section-number">4.3.1</span> <code>mutate()</code>
</h3>
<p><code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> 的工作是添加根据现有列计算的新列。 在转换（transform）章节中，您将学习大量可用于操作不同类型变量的函数。 现在，我们将坚持使用基本代数，它允许我们计算 <code>gain</code>、延迟航班在空中补足的时间以及以英里/小时为单位的 <code>speed</code>：</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>    speed <span class="op">=</span> <span class="va">distance</span> <span class="op">/</span> <span class="va">air_time</span> <span class="op">*</span> <span class="fl">60</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 21</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 13 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>默认情况下，<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> 会在数据集的右侧添加新列，这使得很难看出这里发生了什么。 我们可以使用 <code>.before</code> 参数将变量添加到左侧 <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>：</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>    speed <span class="op">=</span> <span class="va">distance</span> <span class="op">/</span> <span class="va">air_time</span> <span class="op">*</span> <span class="fl">60</span>,</span>
<span>    .before <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 21</span></span>
<span><span class="co">#&gt;    gain speed  year month   day dep_time sched_dep_time dep_delay arr_time</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1    -9  370.  2013     1     1      517            515         2      830</span></span>
<span><span class="co">#&gt; 2   -16  374.  2013     1     1      533            529         4      850</span></span>
<span><span class="co">#&gt; 3   -31  408.  2013     1     1      542            540         2      923</span></span>
<span><span class="co">#&gt; 4    17  517.  2013     1     1      544            545        -1     1004</span></span>
<span><span class="co">#&gt; 5    19  394.  2013     1     1      554            600        -6      812</span></span>
<span><span class="co">#&gt; 6   -16  288.  2013     1     1      554            558        -4      740</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 12 more variables: sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>.</code> 表示 <code>.before</code> 是函数的参数，而不是我们正在创建的第三个新变量的名称。 您还可以使用 <code>.after</code> 来在变量之后添加，并且在 <code>.before</code> 和 <code>.after</code> 中都可以使用变量名而不是位置。 例如，我们可以在 <code>day</code> 之后添加新变量：</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>    speed <span class="op">=</span> <span class="va">distance</span> <span class="op">/</span> <span class="va">air_time</span> <span class="op">*</span> <span class="fl">60</span>,</span>
<span>    .after <span class="op">=</span> <span class="va">day</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者，您可以使用 <code>.keep</code> 参数控制保留哪些变量。 一个特别有用的参数是 <code>"used"</code>，它指定我们只保留在 <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> 步骤中涉及或创建的列。 例如，以下输出将仅包含变量 <code>dep_delay</code>, <code>arr_delay</code>, <code>air_time</code>, <code>gain</code>, <code>hours</code>, and <code>gain_per_hour</code>。</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>    hours <span class="op">=</span> <span class="va">air_time</span> <span class="op">/</span> <span class="fl">60</span>,</span>
<span>    gain_per_hour <span class="op">=</span> <span class="va">gain</span> <span class="op">/</span> <span class="va">hours</span>,</span>
<span>    .keep <span class="op">=</span> <span class="st">"used"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>请注意，由于我们尚未将上述计算的结果分配回 <code>flights</code>，因此新变量 <code>gain,</code>、<code>hours</code>、<code>gain_per_hour</code> 只会被打印出来，而不会存储在数据框中。 如果我们希望它们在数据框中可用以供将来使用，我们应该仔细考虑是否要将结果分配回 <code>flights</code>，用更多变量覆盖原始数据框，或者分配给一个新对象 . 通常，正确的答案是一个新对象，该对象以信息性命名以指示其内容，例如 <code>delay_gain</code>，但您也可能有充分的理由覆盖 <code>flights</code>。</p>
</section><section id="sec-select" class="level3" data-number="4.3.2"><h3 data-number="4.3.2" class="anchored" data-anchor-id="sec-select">
<span class="header-section-number">4.3.2</span> <code>select()</code>
</h3>
<p>获取包含数百甚至数千个变量的数据集并不少见。 在这种情况下，第一个挑战通常只是关注您感兴趣的变量。 <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> 允许您使用基于变量名称的操作快速放大有用的子集：</p>
<ul>
<li>
<p>按名称选择列：</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>选择 year 和 day（含）之间的所有列：</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span><span class="op">:</span><span class="va">day</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>选择除了 year 到 day（含）以外的所有列：</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="va">year</span><span class="op">:</span><span class="va">day</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>您也可以使用 <code>-</code> 代替 <code>!</code>（您很可能会在野外看到它）；我们推荐 <code>!</code> 因为它读起来像 “not”，并且与 <code>&amp;</code> 和 <code>|</code> 结合得很好。</p>
</li>
<li>
<p>选择所有 characters 列：</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.character</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ul>
<p>您可以在 <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> 中使用许多辅助函数：</p>
<ul>
<li>
<code>starts_with("abc")</code>: 匹配以 “abc” 开头的名称。</li>
<li>
<code>ends_with("xyz")</code>: 匹配以 “xyz” 结尾的名称。</li>
<li>
<code>contains("ijk")</code>: 匹配包含 “ijk” 的名称。</li>
<li>
<code>num_range("x", 1:3)</code>: 匹配<code>x1</code>、<code>x2</code> 和 <code>x3</code>。</li>
</ul>
<p>有关详细信息，请参阅 <code><a href="https://dplyr.tidyverse.org/reference/select.html">?select</a></code>。 一但你了解正则表达式（the topic of <a href="regexps.html"><span>Chapter&nbsp;16</span></a>），您还可以使用 <code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches()</a></code> 来选择与模式匹配的变量。</p>
<p>您可以在使用 <code>=</code> 在 <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> 时重命名变量。 新名称出现在 <code>=</code> 的左侧，旧变量出现在右侧：</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>tail_num <span class="op">=</span> <span class="va">tailnum</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 1</span></span>
<span><span class="co">#&gt;   tail_num</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   </span></span>
<span><span class="co">#&gt; 1 N14228  </span></span>
<span><span class="co">#&gt; 2 N24211  </span></span>
<span><span class="co">#&gt; 3 N619AA  </span></span>
<span><span class="co">#&gt; 4 N804JB  </span></span>
<span><span class="co">#&gt; 5 N668DN  </span></span>
<span><span class="co">#&gt; 6 N39463  </span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="rename" class="level3" data-number="4.3.3"><h3 data-number="4.3.3" class="anchored" data-anchor-id="rename">
<span class="header-section-number">4.3.3</span> <code>rename()</code>
</h3>
<p>如果你想保留所有现有变量并且只想重命名一些变量，你可以使用 <code><a href="https://dplyr.tidyverse.org/reference/rename.html">rename()</a></code> 而不是 <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>：</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>tail_num <span class="op">=</span> <span class="va">tailnum</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如果你有一堆命名不一致的列，并且手动修复它们会很痛苦，请查看 <code><a href="https://sfirke.github.io/janitor/reference/clean_names.html">janitor::clean_names()</a></code>，它提供了一些有用的自动清理。</p>
</section><section id="relocate" class="level3" data-number="4.3.4"><h3 data-number="4.3.4" class="anchored" data-anchor-id="relocate">
<span class="header-section-number">4.3.4</span> <code>relocate()</code>
</h3>
<p>使用 <code><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate()</a></code> 移动变量。 您可能希望将相关变量收集在一起或将重要变量移到前面。 默认情况下，<code><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate()</a></code> 将变量移动到前面：</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">time_hour</span>, <span class="va">air_time</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;   time_hour           air_time  year month   day dep_time sched_dep_time</span></span>
<span><span class="co">#&gt;   &lt;dttm&gt;                 &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 2013-01-01 05:00:00      227  2013     1     1      517            515</span></span>
<span><span class="co">#&gt; 2 2013-01-01 05:00:00      227  2013     1     1      533            529</span></span>
<span><span class="co">#&gt; 3 2013-01-01 05:00:00      160  2013     1     1      542            540</span></span>
<span><span class="co">#&gt; 4 2013-01-01 05:00:00      183  2013     1     1      544            545</span></span>
<span><span class="co">#&gt; 5 2013-01-01 06:00:00      116  2013     1     1      554            600</span></span>
<span><span class="co">#&gt; 6 2013-01-01 05:00:00      150  2013     1     1      554            558</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 12 more variables: dep_delay &lt;dbl&gt;, arr_time &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>您还可以使用 <code>.before</code> 和 <code>.after</code> 参数指定放置它们的位置，就像在 <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> 中一样：</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">year</span><span class="op">:</span><span class="va">dep_time</span>, .after <span class="op">=</span> <span class="va">time_hour</span><span class="op">)</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"arr"</span><span class="op">)</span>, .before <span class="op">=</span> <span class="va">dep_time</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="exercises-1" class="level3" data-number="4.3.5"><h3 data-number="4.3.5" class="anchored" data-anchor-id="exercises-1">
<span class="header-section-number">4.3.5</span> Exercises</h3>
<div class="cell">

</div>
<ol type="1">
<li><p>比较 <code>dep_time</code>, <code>sched_dep_time</code>, and <code>dep_delay</code>。 您认为这三个数字之间有何关联？</p></li>
<li><p>尽可能多地集思广益，从 <code>flights</code> 中选择 <code>dep_time</code>、<code>dep_delay</code>、<code>arr_time</code> 和 <code>arr_delay</code>。</p></li>
<li><p>如果您在 <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> 调用中多次指定同一个变量的名称，会发生什么情况？</p></li>
<li>
<p><code><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of()</a></code> 函数有什么作用？ 为什么将它与该载体结合使用会有所帮助？</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"month"</span>, <span class="st">"day"</span>, <span class="st">"dep_delay"</span>, <span class="st">"arr_delay"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>运行以下代码的结果是否让您感到惊讶？ 默认情况下，select helpers 如何处理大写和小写？ 你怎么能改变这个默认值？</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"TIME"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li><p>将 <code>air_time</code> 重命名为 <code>air_time_min</code> 以指示测量单位并将其移至数据框的开头。</p></li>
<li>
<p>为什么以下不起作用，错误是什么意思？</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in `arrange()`:</span></span>
<span><span class="co">#&gt; ℹ In argument: `..1 = arr_delay`.</span></span>
<span><span class="co">#&gt; Caused by error:</span></span>
<span><span class="co">#&gt; ! object 'arr_delay' not found</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ol></section></section><section id="sec-the-pipe" class="level2" data-number="4.4"><h2 data-number="4.4" class="anchored" data-anchor-id="sec-the-pipe">
<span class="header-section-number">4.4</span> The pipe</h2>
<p>我们已经在前面向您展示了管道（pipe）的简单示例，但当您开始组合多个 verbs 时，它的真正威力就会显现出来。 例如，假设您想找到飞往休斯顿 IAH 机场的快速航班：您需要结合使用 <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>：</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="st">"IAH"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>speed <span class="op">=</span> <span class="va">distance</span> <span class="op">/</span> <span class="va">air_time</span> <span class="op">*</span> <span class="fl">60</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span><span class="op">:</span><span class="va">day</span>, <span class="va">dep_time</span>, <span class="va">carrier</span>, <span class="va">flight</span>, <span class="va">speed</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">speed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 7,198 × 7</span></span>
<span><span class="co">#&gt;    year month   day dep_time carrier flight speed</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;chr&gt;    &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     7     9      707 UA         226  522.</span></span>
<span><span class="co">#&gt; 2  2013     8    27     1850 UA        1128  521.</span></span>
<span><span class="co">#&gt; 3  2013     8    28      902 UA        1711  519.</span></span>
<span><span class="co">#&gt; 4  2013     8    28     2122 UA        1022  519.</span></span>
<span><span class="co">#&gt; 5  2013     6    11     1628 UA        1178  515.</span></span>
<span><span class="co">#&gt; 6  2013     8    27     1017 UA         333  515.</span></span>
<span><span class="co">#&gt; # ℹ 7,192 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>尽管这个管道有四个步骤，但它很容易浏览，因为 verbs 出现在每一行的开头：从 <code>flights</code> 数据开始，then filter, then mutate, then select, then arrange。</p>
<p>如果我们没有管道会怎样？ 我们可以将每个函数调用嵌套在前一个调用中：</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>        <span class="va">flights</span>, </span>
<span>        <span class="va">dest</span> <span class="op">==</span> <span class="st">"IAH"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      speed <span class="op">=</span> <span class="va">distance</span> <span class="op">/</span> <span class="va">air_time</span> <span class="op">*</span> <span class="fl">60</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="va">year</span><span class="op">:</span><span class="va">day</span>, <span class="va">dep_time</span>, <span class="va">carrier</span>, <span class="va">flight</span>, <span class="va">speed</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">speed</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者我们可以使用一堆中间对象：</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">dest</span> <span class="op">==</span> <span class="st">"IAH"</span><span class="op">)</span></span>
<span><span class="va">flights2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">flights1</span>, speed <span class="op">=</span> <span class="va">distance</span> <span class="op">/</span> <span class="va">air_time</span> <span class="op">*</span> <span class="fl">60</span><span class="op">)</span></span>
<span><span class="va">flights3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights2</span>, <span class="va">year</span><span class="op">:</span><span class="va">day</span>, <span class="va">dep_time</span>, <span class="va">carrier</span>, <span class="va">flight</span>, <span class="va">speed</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">flights3</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">speed</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>虽然这两种形式都有它们的时间和地点，但管道通常会产生更易于编写和阅读的数据分析代码。</p>
<p>要将管道添加到代码中，我们建议使用内置键盘快捷键 Ctrl/Cmd + Shift + M。 您需要对 RStudio 选项进行一项更改，以使用 <code>|&gt;</code> 而不是 <code>%&gt;%</code>，如 <a href="#fig-pipe-options">Figure&nbsp;<span>4.1</span></a> 中所示；稍后将详细介绍 <code>%&gt;%</code>。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pipe-options" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="screenshots/rstudio-pipe-options.png" class="img-fluid figure-img" alt="Screenshot showing the &quot;Use native pipe operator&quot; option which can be found on the &quot;Editing&quot; panel of the &quot;Code&quot; options." width="616"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;4.1: To insert <code>|&gt;</code>, make sure the “Use native pipe operator” option is checked.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
magrittr
</div>
</div>
<div class="callout-body-container callout-body">
<p>如果您已经使用 tidyverse 一段时间，您可能熟悉 <strong>magrittr</strong> 包提供的 <code>%&gt;%</code> 管道。 magrittr 包包含在核心 tidyverse 中，因此您可以在加载 tidyverse 时使用 <code>%&gt;%</code>：</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>对于简单的情况，<code>|&gt;</code> 和 <code>%&gt;%</code> 的行为相同。 那么为什么我们推荐 base pipe（<code>|&gt;</code>）呢？ 首先，因为它是 base R 的一部分，所以它始终可供您使用，即使您不使用 tidyverse。 其次，<code>|&gt;</code> 比 <code>%&gt;%</code> 简单得多：从 2014 年发明 <code>%&gt;%</code> 到 2021 年将 <code>|&gt;</code> 包含在 R 4.1.0 之间，我们对管道有了更好地了解。 这允许基本实现放弃不常用和不太重要的功能。</p>
</div>
</div>
</section><section id="groups" class="level2" data-number="4.5"><h2 data-number="4.5" class="anchored" data-anchor-id="groups">
<span class="header-section-number">4.5</span> Groups</h2>
<p>到目前为止，您已经了解了处理行和列的函数。 当您添加与组（groups）一起工作的能力时，dplyr 变得更加强大。 在本节中，我们将重点关注最重要的函数：<code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code> 和 slice 函数系列。</p>
<section id="group_by" class="level3" data-number="4.5.1"><h3 data-number="4.5.1" class="anchored" data-anchor-id="group_by">
<span class="header-section-number">4.5.1</span> <code>group_by()</code>
</h3>
<p>使用 <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> 将您的数据集分成对您的分析有意义的组：</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt; # Groups:   month [12]</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> 不会更改数据，但是，如果您仔细查看输出，您会注意到输出表明它是按 month 分组的（<code>Groups: month [12]</code>）。 这意味着后续操作现在将按 month 进行。 <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> 将这个分组特征（称为类）添加到数据框，这改变了应用于数据的后续 verbs 的行为。</p>
</section><section id="sec-summarize" class="level3" data-number="4.5.2"><h3 data-number="4.5.2" class="anchored" data-anchor-id="sec-summarize">
<span class="header-section-number">4.5.2</span> <code>summarize()</code>
</h3>
<p>最重要的分组操作是 summary，如果用于计算单个汇总统计数据，则会将数据框减少为每个组只有一行。 在 dplyr 中，此操作由 <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> 执行，如下例所示，它按月计算平均出发延迟：</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    avg_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 12 × 2</span></span>
<span><span class="co">#&gt;   month avg_delay</span></span>
<span><span class="co">#&gt;   &lt;int&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1        NA</span></span>
<span><span class="co">#&gt; 2     2        NA</span></span>
<span><span class="co">#&gt; 3     3        NA</span></span>
<span><span class="co">#&gt; 4     4        NA</span></span>
<span><span class="co">#&gt; 5     5        NA</span></span>
<span><span class="co">#&gt; 6     6        NA</span></span>
<span><span class="co">#&gt; # ℹ 6 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>呃！ 出了点问题，我们所有的结果都是 <code>NA</code>（发音为”N-A”），R 的缺失值符号。 发生这种情况是因为一些观察到的航班在延误列中缺少数据，因此当我们计算包括这些值的平均值时，我们得到了 <code>NA</code> 结果。 我们将在 <a href="missing-values.html"><span>Chapter&nbsp;19</span></a> 中回来详细讨论缺失值，但现在我们将告诉 <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> 函数通过将参数 <code>na.rm</code> 设置为 <code>TRUE</code> 来忽略所有缺失值：</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 12 × 2</span></span>
<span><span class="co">#&gt;   month delay</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1  10.0</span></span>
<span><span class="co">#&gt; 2     2  10.8</span></span>
<span><span class="co">#&gt; 3     3  13.2</span></span>
<span><span class="co">#&gt; 4     4  13.9</span></span>
<span><span class="co">#&gt; 5     5  13.0</span></span>
<span><span class="co">#&gt; 6     6  20.8</span></span>
<span><span class="co">#&gt; # ℹ 6 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>您可以在一次调用 <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code> 中创建任意数量的 summaries。 您将在接下来的章节中学习各种有用的 summaries，但一个非常有用的 summary 是 <code><a href="https://dplyr.tidyverse.org/reference/context.html">n()</a></code>，它返回每组中的行数：</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 12 × 3</span></span>
<span><span class="co">#&gt;   month delay     n</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1     1  10.0 27004</span></span>
<span><span class="co">#&gt; 2     2  10.8 24951</span></span>
<span><span class="co">#&gt; 3     3  13.2 28834</span></span>
<span><span class="co">#&gt; 4     4  13.9 28330</span></span>
<span><span class="co">#&gt; 5     5  13.0 28796</span></span>
<span><span class="co">#&gt; 6     6  20.8 28243</span></span>
<span><span class="co">#&gt; # ℹ 6 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Means 和 counts 可以让你在数据科学中走得更远！</p>
</section><section id="the-slice_-functions" class="level3" data-number="4.5.3"><h3 data-number="4.5.3" class="anchored" data-anchor-id="the-slice_-functions">
<span class="header-section-number">4.5.3</span> The <code>slice_</code> functions</h3>
<p>有五个方便的函数可让您提取每个组中的特定行：</p>
<ul>
<li>
<code>df |&gt; slice_head(n = 1)</code> 从每组中取出第一行。</li>
<li>
<code>df |&gt; slice_tail(n = 1)</code> 从每组中取出最后一行。</li>
<li>
<code>df |&gt; slice_min(x, n = 1)</code> 获取列 <code>x</code> 中具有最小值的行。</li>
<li>
<code>df |&gt; slice_max(x, n = 1)</code> 获取列 <code>x</code> 中具有最大值的行。</li>
<li>
<code>df |&gt; slice_sample(n = 1)</code> 取一个随机行。</li>
</ul>
<p>您可以改变 <code>n</code> 以选择多行，或者不使用 <code>n =</code>，您可以使用 <code>prop = 0.1</code> 来选择（例如）每组中 10% 的行。 例如，以下代码查找到达每个目的地时最晚延误的航班：</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dest</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span><span class="va">arr_delay</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">dest</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 108 × 19</span></span>
<span><span class="co">#&gt; # Groups:   dest [105]</span></span>
<span><span class="co">#&gt;   dest   year month   day dep_time sched_dep_time dep_delay arr_time</span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 ABQ    2013     7    22     2145           2007        98      132</span></span>
<span><span class="co">#&gt; 2 ACK    2013     7    23     1139            800       219     1250</span></span>
<span><span class="co">#&gt; 3 ALB    2013     1    25      123           2000       323      229</span></span>
<span><span class="co">#&gt; 4 ANC    2013     8    17     1740           1625        75     2042</span></span>
<span><span class="co">#&gt; 5 ATL    2013     7    22     2257            759       898      121</span></span>
<span><span class="co">#&gt; 6 AUS    2013     7    10     2056           1505       351     2347</span></span>
<span><span class="co">#&gt; # ℹ 102 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>请注意，有 105 个目的地（destinations），但我们在这里得到 108 行。 这是怎么回事？ <code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_min()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max()</a></code> 保持绑定值，所以 <code>n = 1</code> 意味着给我们所有具有最高值的行。 如果您只想每组一行，您可以设置 <code>with_ties = FALSE</code>。</p>
<p>这类似于使用 <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code> 计算最大延迟，但是您得到的是整个对应行（如果有平局则为行）而不是单个汇总统计数据。</p>
</section><section id="grouping-by-multiple-variables" class="level3" data-number="4.5.4"><h3 data-number="4.5.4" class="anchored" data-anchor-id="grouping-by-multiple-variables">
<span class="header-section-number">4.5.4</span> Grouping by multiple variables</h3>
<p>您可以使用多个变量创建 groups。 例如，我们可以为每个日期创建一个 group。</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span></span>
<span><span class="va">daily</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt; # Groups:   year, month, day [365]</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>当您 summarize 由多个变量分组的 tibble 时，每个 summary 都会剥离最后一组。 事后看来，这不是使该功能正常工作的好方法，但在不破坏现有代码的情况下很难进行更改。 为了使发生的事情一目了然，dplyr 会显示一条消息，告诉您如何更改此行为：</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_flights</span> <span class="op">&lt;-</span> <span class="va">daily</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year', 'month'. You can override using</span></span>
<span><span class="co">#&gt; the `.groups` argument.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如果您对此行为感到满意，您可以明确请求它以抑制消息：</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_flights</span> <span class="op">&lt;-</span> <span class="va">daily</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    .groups <span class="op">=</span> <span class="st">"drop_last"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者，通过设置不同的值来更改默认行为，例如，<code>"drop"</code> 删除所有分组或 <code>"keep"</code> 保留相同的组。</p>
</section><section id="ungrouping" class="level3" data-number="4.5.5"><h3 data-number="4.5.5" class="anchored" data-anchor-id="ungrouping">
<span class="header-section-number">4.5.5</span> Ungrouping</h3>
<p>您可能还想在不使用 <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code> 的情况下从数据框中删除分组。 你可以用 <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup()</a></code> 来做到这一点。</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; 2  2013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; 3  2013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span></span>
<span><span class="co">#&gt; 5  2013     1     1      554            600        -6      812            837</span></span>
<span><span class="co">#&gt; 6  2013     1     1      554            558        -4      740            728</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>现在让我们看看当您汇总未分组的数据框时会发生什么。</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    avg_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 2</span></span>
<span><span class="co">#&gt;   avg_delay flights</span></span>
<span><span class="co">#&gt;       &lt;dbl&gt;   &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1      12.6  336776</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>您会返回一行，因为 dplyr 将未分组数据框中的所有行视为属于一个组。</p>
</section><section id="by" class="level3" data-number="4.5.6"><h3 data-number="4.5.6" class="anchored" data-anchor-id="by">
<span class="header-section-number">4.5.6</span> <code>.by</code>
</h3>
<p>dplyr 1.1.0 包括一个新的、实验性的、用于每个操作分组的语法，即 <code>.by</code> 参数。 <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup()</a></code> 不会消失，但您现在还可以使用 <code>.by</code> 参数在单个操作中进行分组：</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="va">month</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者如果你想按多个变量分组：</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">dest</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>.by</code> 适用于所有动词，优点是您不需要使用 <code>.groups</code> 参数来取消分组消息或在完成后使用 <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup()</a></code>。</p>
<p>我们在本章中没有关注这个语法，因为在我们写这本书的时候它是非常新的。 我们确实想提及它，因为我们认为它有很多希望并且很可能很受欢迎。 您可以在 <a href="https://www.tidyverse.org/blog/2023/02/dplyr-1-1-0-per-operation-grouping/">dplyr 1.1.0 博客文章</a> 中了解更多信息。</p>
</section><section id="exercises-2" class="level3" data-number="4.5.7"><h3 data-number="4.5.7" class="anchored" data-anchor-id="exercises-2">
<span class="header-section-number">4.5.7</span> Exercises</h3>
<ol type="1">
<li><p>哪家航空公司的平均延误最严重？ 挑战：你能分清糟糕机场与糟糕承运人的影响吗？ 为什么/为什么不？ （提示：考虑 <code>flights |&gt; group_by(carrier, dest) |&gt; summarize(n())</code>）</p></li>
<li><p>找出从每个目的地出发时延误最严重的航班。</p></li>
<li><p>一天中的延迟如何变化。 用一个图说明你的答案。</p></li>
<li><p>如果您向 <code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_min()</a></code> 和相关函数提供负数 <code>n</code> 会发生什么？</p></li>
<li><p>根据您刚刚学习的 dplyr verbs 解释 <code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code> 的作用。 <code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code> 的 <code>sort</code> 参数有什么作用？</p></li>
<li>
<p>假设我们有以下微型数据框：</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>,</span>
<span>  z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"K"</span>, <span class="st">"K"</span>, <span class="st">"L"</span>, <span class="st">"L"</span>, <span class="st">"K"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="a">
<li>
<p>写下您认为输出的样子，然后检查您是否正确，并描述 <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> 的作用。</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>写下您认为输出的样子，然后检查您是否正确，并描述 <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> 的作用。 还要评论它与 (a) 部分中的 <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> 有何不同？</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>写下您认为输出的样子，然后检查您是否正确，并描述 pipeline 的作用。</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>写下您认为输出的样子，然后检查您是否正确，并描述 pipeline 的作用。 然后，评论消息的内容。</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">z</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>写下您认为输出的样子，然后检查您是否正确，并描述 pipeline 的作用。 输出与 (d) 部分中的输出有何不同。</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">z</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>写下您认为输出的样子，然后检查您是否正确，并描述 pipeline 的作用。 两条 pipelines 的输出有何不同？</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">z</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">z</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ol>
</li>
</ol></section></section><section id="sec-sample-size" class="level2" data-number="4.6"><h2 data-number="4.6" class="anchored" data-anchor-id="sec-sample-size">
<span class="header-section-number">4.6</span> Case study: aggregates and sample size</h2>
<p>每当您进行任何聚合（aggregation）时，包含一个计数 (<code><a href="https://dplyr.tidyverse.org/reference/context.html">n()</a></code>) 总是一个好主意。 这样，您就可以确保您不会根据非常少量的数据得出结论。 我们将使用 <strong>Lahman</strong> 包中的一些 baseball 数据来证明这一点。 具体来说，我们将比较球员击球次数 (<code>H</code>) 与他们尝试将球投入比赛的次数 (<code>AB</code>) 的比例：</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">batters</span> <span class="op">&lt;-</span> <span class="fu">Lahman</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/Lahman/man/Batting.html">Batting</a></span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">playerID</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    performance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">H</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">AB</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">AB</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">batters</span></span>
<span><span class="co">#&gt; # A tibble: 20,469 × 3</span></span>
<span><span class="co">#&gt;   playerID  performance     n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;           &lt;dbl&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 aardsda01      0          4</span></span>
<span><span class="co">#&gt; 2 aaronha01      0.305  12364</span></span>
<span><span class="co">#&gt; 3 aaronto01      0.229    944</span></span>
<span><span class="co">#&gt; 4 aasedo01       0          5</span></span>
<span><span class="co">#&gt; 5 abadan01       0.0952    21</span></span>
<span><span class="co">#&gt; 6 abadfe01       0.111      9</span></span>
<span><span class="co">#&gt; # ℹ 20,463 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>当我们绘制击球手的技能（以击球率 <code>performance</code> 衡量）与击球机会的数量（以击球次数 <code>n</code> 衡量）之间的关系时，您会看到两种模式：</p>
<ol type="1">
<li><p>在击球次数较少的球员中，<code>performance</code> 的差异更大。 该图的形状非常有特色：每当您绘制平均值（或其他汇总统计数据）与组大小的关系时，您都会看到变异随着样本大小的增加而减小<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>。</p></li>
<li><p>技能（<code>performance</code>）和击球机会 (<code>n</code>) 之间存在正相关关系，因为球队希望给最好的击球手最多的击球机会。</p></li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">batters</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">performance</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="data-transform_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" alt="A scatterplot of number of batting performance vs. batting opportunites overlaid with a smoothed line. Average performance increases sharply from 0.2 at when n is 1 to 0.25 when n is ~1000. Average performance continues to increase linearly at a much shallower slope reaching ~0.3 when n is ~15,000." width="576"></p>
</div>
</div>
<p>请注意组合 ggplot2 和 dplyr 的便利模式。 您只需要记住从用于数据集处理的 <code>|&gt;</code> 切换到用于向绘图添加图层的 <code>+</code> 。</p>
<p>这对排名也有重要影响。 如果你天真地按 <code>desc(performance)</code> 排序，平均击球率最好的人显然是那些尝试将球打入比赛并碰巧被击中的人，他们不一定是技术最好的球员 :</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">batters</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">performance</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 20,469 × 3</span></span>
<span><span class="co">#&gt;   playerID  performance     n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;           &lt;dbl&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 abramge01           1     1</span></span>
<span><span class="co">#&gt; 2 alberan01           1     1</span></span>
<span><span class="co">#&gt; 3 banisje01           1     1</span></span>
<span><span class="co">#&gt; 4 bartocl01           1     1</span></span>
<span><span class="co">#&gt; 5 bassdo01            1     1</span></span>
<span><span class="co">#&gt; 6 birasst01           1     2</span></span>
<span><span class="co">#&gt; # ℹ 20,463 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>您可以在 <a href="http://varianceexplained.org/r/empirical_bayes_baseball/" class="uri">http://varianceexplained.org/r/empirical_bayes_baseball/</a> 和 <a href="https://www.evanmiller.org/how-not-to-sort-by-average-rating.html" class="uri">https://www.evanmiller.org/how-not-to-sort-by-average-rating.html</a> 找到这个问题的一个很好的解释以及如何克服它。</p>
</section><section id="summary" class="level2" data-number="4.7"><h2 data-number="4.7" class="anchored" data-anchor-id="summary">
<span class="header-section-number">4.7</span> Summary</h2>
<p>在本章中，您学习了 dplyr 提供的用于处理 data frames 的工具。 这些工具大致分为三类：操作行的工具（如 <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>），操作列的工具（如 <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>），以及那些 操纵组的工具（如 <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code>）。 在本章中，我们重点介绍了这些 “whole data frame” 工具，但您还没有学到很多关于可以使用单个变量做什么的知识。 我们将在本书的 Transform 部分回到这一点，每一章都会为您提供用于特定类型变量的工具。</p>
<p>在下一章中，我们将回到工作流来讨论代码风格的重要性，让您的代码井井有条，以便您和其他人轻松阅读和理解您的代码。</p>


</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>稍后，您将了解 <code>slice_*()</code> 系列，它允许您根据行的位置选择行。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>请记住，在 RStudio 中，查看包含许多列的数据集的最简单方法是 <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code>。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Or <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code>, if you prefer British English.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>*cough* the law of large numbers *cough*.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./workflow-basics.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Workflow: basics</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./workflow-style.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Workflow: code style</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">R for Data Science (2e) was written by Hadley Wickham, Mine Çetinkaya-Rundel, and Garrett Grolemund.</div>   
    <div class="nav-footer-right">This book was built with <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


</body></html>